{% extends "tickets/base.html" %}

{% block title %}Ticket #{{ ticket.id }} · ServiceDesk{% endblock %}

{% block topbar_actions %}
  <a class="btn" href="/tickets/">All tickets</a>
  <a class="btn primary" href="/tickets/new/">+ New ticket</a>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-header">
      <h2>Ticket #{{ ticket.id }} — {{ ticket.title }}</h2>
      <div class="sub">A clear view of the issue and its current state.</div>
    </div>

    <div class="card-body">
      <div class="badges" style="justify-content:flex-start;">
      {% if user.is_authenticated %}
        {% if user.is_staff or ticket.owner == user %}
          <div class="actions" style="margin-top: 14px;">
            <a class="btn" href="/tickets/{{ ticket.id }}/edit/">Edit</a>
            <a class="btn" href="/tickets/{{ ticket.id }}/delete/" style="background: rgba(248,113,113,.18);">Delete</a>
          </div>
        {% endif %}
      {% endif %}

        <span class="badge info">{{ ticket.get_status_display }}</span>

        {% if ticket.priority == "URGENT" or ticket.priority == "HIGH" %}
          <span class="badge bad">{{ ticket.get_priority_display }}</span>
        {% elif ticket.priority == "MEDIUM" %}
          <span class="badge warn">{{ ticket.get_priority_display }}</span>
        {% else %}
          <span class="badge good">{{ ticket.get_priority_display }}</span>
        {% endif %}

      </div>

      <div class="divider"></div>

      {% if ticket.description %}
        <p style="margin:0; line-height:1.6;">{{ ticket.description }}</p>
      {% else %}
        <p class="small"><em>No description provided.</em></p>
      {% endif %}

      <div class="divider"></div>
      <div class="divider"></div>

      <h3 style="margin:0 0 10px 0;">Comments</h3>

      {% if comments %}
        <div style="display:flex; flex-direction:column; gap:10px;">
          {% for c in comments %}
            <div style="padding:12px; border:1px solid var(--border); border-radius:14px; background: rgba(255,255,255,.04);">
              <div class="small" style="margin-bottom:8px;">
                <strong>{{ c.author.username }}</strong> · {{ c.created_at|date:"j M Y, H:i" }}
              </div>
              <div style="white-space:pre-wrap; line-height:1.6;">{{ c.message }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="small">No comments yet.</p>
      {% endif %}

      {% if user.is_authenticated %}
        <div class="divider"></div>

        <h3 style="margin:0 0 10px 0;">Add a comment</h3>

        <form method="post" class="form-grid">
          {% csrf_token %}
          <div>
            <label for="{{ comment_form.message.id_for_label }}">Message</label>
            {{ comment_form.message }}
          </div>

          <div class="actions">
            <button class="btn primary" type="submit">Post comment</button>
          </div>
        </form>
      {% else %}
        <div class="divider"></div>
        <p class="small">
          <a class="btn" href="/accounts/login/">Sign in</a> to add a comment.
        </p>
      {% endif %}
      
      <p class="small">
        Created: {{ ticket.created_at|date:"j M Y, H:i" }} ·
        Updated: {{ ticket.updated_at|date:"j M Y, H:i" }}
      </p>
    </div>
  </div>
{% endblock %}